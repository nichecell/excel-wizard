// ÏãúÌä∏ ÏÑ†ÌÉù Î≥ëÌï© ÎèÑÍµ¨
class SheetSelectorTool {
  constructor() {
    this.uploadedFiles = [];
    this.fileWorkbooks = new Map(); // ÌååÏùºÎ≥Ñ ÏõåÌÅ¨Î∂Å Ï†ÄÏû•
    this.selectedSheets = []; // ÏÑ†ÌÉùÎêú ÏãúÌä∏Îì§
    this.mergedWorkbook = null;
    this.currentStep = 1;
    this.currentPreviewSheet = null;
    this.setupEventListeners();
  }

  init() {
    console.log("Sheet Selector Tool initialized");
    this.resetTool();
  }

  setupEventListeners() {
    // 1Îã®Í≥Ñ Ïù¥Î≤§Ìä∏
    const uploadArea = document.getElementById("sheetSelectorUploadArea");
    const fileInput = document.getElementById("sheetSelectorFileInput");
    const clearFilesBtn = document.getElementById("clearFilesBtn");
    const analyzeFilesBtn = document.getElementById("analyzeFilesBtn");

    // 2Îã®Í≥Ñ Ïù¥Î≤§Ìä∏
    const selectAllBtn = document.getElementById("selectAllSheetsBtn");
    const deselectAllBtn = document.getElementById("deselectAllSheetsBtn");
    const backToUploadBtn = document.getElementById("backToUploadBtn");
    const previewSelectedBtn = document.getElementById("previewSelectedBtn");

    // 3Îã®Í≥Ñ Ïù¥Î≤§Ìä∏
    const backToSelectionBtn = document.getElementById("backToSelectionBtn");
    const mergeSelectedSheetsBtn = document.getElementById(
      "mergeSelectedSheetsBtn"
    );

    // 4Îã®Í≥Ñ Ïù¥Î≤§Ìä∏
    const downloadMergedBtn = document.getElementById("downloadMergedBtn");
    const startOverBtn = document.getElementById("startOverBtn");

    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
    if (uploadArea) {
      uploadArea.addEventListener("dragover", this.handleDragOver.bind(this));
      uploadArea.addEventListener("dragleave", this.handleDragLeave.bind(this));
      uploadArea.addEventListener("drop", this.handleDrop.bind(this));
      uploadArea.addEventListener("click", (e) => {
        // labelÏùÑ ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞Í∞Ä ÏïÑÎãê ÎïåÎßå ÌååÏùº ÏûÖÎ†• ÌÅ¥Î¶≠
        if (!e.target.closest("label")) {
          fileInput.click();
        }
      });
    }

    if (fileInput) {
      fileInput.addEventListener("change", this.handleFileSelect.bind(this));
    }

    if (clearFilesBtn) {
      clearFilesBtn.addEventListener("click", this.clearFiles.bind(this));
    }

    if (analyzeFilesBtn) {
      analyzeFilesBtn.addEventListener("click", this.analyzeFiles.bind(this));
    }

    if (selectAllBtn) {
      selectAllBtn.addEventListener("click", this.selectAllSheets.bind(this));
    }

    if (deselectAllBtn) {
      deselectAllBtn.addEventListener(
        "click",
        this.deselectAllSheets.bind(this)
      );
    }

    if (backToUploadBtn) {
      backToUploadBtn.addEventListener("click", () => this.goToStep(1));
    }

    if (previewSelectedBtn) {
      previewSelectedBtn.addEventListener("click", this.goToPreview.bind(this));
    }

    if (backToSelectionBtn) {
      backToSelectionBtn.addEventListener("click", () => this.goToStep(2));
    }

    if (mergeSelectedSheetsBtn) {
      mergeSelectedSheetsBtn.addEventListener(
        "click",
        this.mergeSelectedSheets.bind(this)
      );
    }

    if (downloadMergedBtn) {
      downloadMergedBtn.addEventListener(
        "click",
        this.downloadMergedFile.bind(this)
      );
    }

    if (startOverBtn) {
      startOverBtn.addEventListener("click", this.resetTool.bind(this));
    }
  }

  // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Ï≤òÎ¶¨
  handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add("dragover");
  }

  handleDragLeave(e) {
    e.currentTarget.classList.remove("dragover");
  }

  handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove("dragover");
    if (e.dataTransfer.files.length > 0) {
      this.handleFiles(e.dataTransfer.files);
    }
  }

  handleFileSelect(e) {
    if (e.target.files.length > 0) {
      this.handleFiles(e.target.files);
    }
  }

  // ÌååÏùº Ï≤òÎ¶¨
  handleFiles(files) {
    const excelFiles = Array.from(files).filter(
      (file) => file.name.endsWith(".xls") || file.name.endsWith(".xlsx")
    );

    excelFiles.forEach((file) => {
      if (!this.uploadedFiles.find((f) => f.name === file.name)) {
        this.uploadedFiles.push(file);
      }
    });

    this.updateUploadedFilesList();
    this.updateAnalyzeButton();
  }

  updateUploadedFilesList() {
    const filesList = document.getElementById("uploadedFilesList");
    if (!filesList) return;

    filesList.innerHTML = "";

    this.uploadedFiles.forEach((file, index) => {
      const fileItem = document.createElement("div");
      fileItem.className = "uploaded-file-item";

      fileItem.innerHTML = `
                <div class="file-info">
                    <div class="file-name">${this.escapeHtml(file.name)}</div>
                    <div class="file-details">
                        <div class="file-size">
                            üìÅ ${this.formatFileSize(file.size)}
                        </div>
                        <div class="sheet-count-info" id="sheet-count-${index}">
                            ${
                              window.t
                                ? window.t("sheetSelector.progress.waiting")
                                : "‚è≥ Î∂ÑÏÑù ÎåÄÍ∏∞ Ï§ë..."
                            }
                        </div>
                    </div>
                </div>
                <button class="remove-file-btn" onclick="sheetSelectorTool.removeFile(${index})">
                    ${window.t ? window.t("common.remove") : "Ï†úÍ±∞"}
                </button>
            `;

      filesList.appendChild(fileItem);
    });
  }

  removeFile(index) {
    this.uploadedFiles.splice(index, 1);
    this.updateUploadedFilesList();
    this.updateAnalyzeButton();
  }

  clearFiles() {
    this.uploadedFiles = [];
    this.fileWorkbooks.clear();
    this.selectedSheets = [];
    this.updateUploadedFilesList();
    this.updateAnalyzeButton();
  }

  updateAnalyzeButton() {
    const analyzeBtn = document.getElementById("analyzeFilesBtn");
    if (analyzeBtn) {
      analyzeBtn.disabled = this.uploadedFiles.length === 0;
    }
  }

  // ÌååÏùº Î∂ÑÏÑù
  async analyzeFiles() {
    if (this.uploadedFiles.length === 0) return;

    this.showProgress(
      window.t
        ? window.t("sheetSelector.progress.analyzing")
        : "ÌååÏùºÎì§ÏùÑ Î∂ÑÏÑùÌïòÎäî Ï§ë...",
      0
    );

    try {
      for (let i = 0; i < this.uploadedFiles.length; i++) {
        const file = this.uploadedFiles[i];
        const progress = (i / this.uploadedFiles.length) * 100;

        this.updateProgress(
          window.t
            ? window.t("sheetSelector.progress.analyzingFile", {
                fileName: file.name,
              })
            : `${file.name} Î∂ÑÏÑù Ï§ë...`,
          progress
        );

        const arrayBuffer = await this.readFileAsArrayBuffer(file);
        const workbook = XLSX.read(arrayBuffer, { type: "array" });

        this.fileWorkbooks.set(file.name, workbook);

        // UI ÏóÖÎç∞Ïù¥Ìä∏
        const sheetCountEl = document.getElementById(`sheet-count-${i}`);
        if (sheetCountEl) {
          sheetCountEl.innerHTML = `üìÑ ${
            window.t
              ? window.t("sheetSelector.info.sheetCount", {
                  count: workbook.SheetNames.length,
                })
              : `${workbook.SheetNames.length}Í∞ú ÏãúÌä∏`
          }`;
        }
      }

      this.hideProgress();
      this.goToStep(2);
      this.displaySheetsList();
    } catch (error) {
      this.hideProgress();
      alert(
        (window.t
          ? window.t("sheetSelector.errors.analysisError")
          : "ÌååÏùº Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:") +
          " " +
          error.message
      );
      console.error(error);
    }
  }

  // 2Îã®Í≥Ñ: ÏãúÌä∏ Î™©Î°ù ÌëúÏãú
  displaySheetsList() {
    const sheetsList = document.getElementById("sheetsList");
    if (!sheetsList) return;

    sheetsList.innerHTML = "";

    this.uploadedFiles.forEach((file) => {
      const workbook = this.fileWorkbooks.get(file.name);
      if (!workbook) return;

      const fileGroup = document.createElement("div");
      fileGroup.className = "file-group";

      // ÌååÏùº Ìó§Îçî
      const fileHeader = document.createElement("div");
      fileHeader.className = "file-group-header";
      fileHeader.innerHTML = `
                <span class="file-icon">üìÅ</span>
                <span>${this.escapeHtml(file.name)}</span>
                <span style="margin-left: auto; color: var(--text-secondary);">
                    ${
                      window.t
                        ? window.t("sheetSelector.info.sheetCount", {
                            count: workbook.SheetNames.length,
                          })
                        : `${workbook.SheetNames.length}Í∞ú ÏãúÌä∏`
                    }
                </span>
            `;
      fileGroup.appendChild(fileHeader);

      // ÏãúÌä∏ Î™©Î°ù
      workbook.SheetNames.forEach((sheetName) => {
        const sheetItem = document.createElement("div");
        sheetItem.className = "sheet-item";

        const sheetId = `${file.name}::${sheetName}`;

        sheetItem.innerHTML = `
                    <input type="checkbox" class="sheet-checkbox" id="sheet-${this.hashString(
                      sheetId
                    )}" 
                           data-file="${this.escapeHtml(file.name)}" 
                           data-sheet="${this.escapeHtml(sheetName)}">
                    <div class="sheet-info">
                        <span class="sheet-name">${this.escapeHtml(
                          sheetName
                        )}</span>
                        <button class="sheet-preview-btn" onclick="sheetSelectorTool.previewSheet('${this.escapeHtml(
                          file.name
                        )}', '${this.escapeHtml(sheetName)}')">
                            ${
                              window.t ? window.t("common.preview") : "ÎØ∏Î¶¨Î≥¥Í∏∞"
                            }
                        </button>
                    </div>
                `;

        fileGroup.appendChild(sheetItem);
      });

      sheetsList.appendChild(fileGroup);
    });

    // Ï≤¥ÌÅ¨Î∞ïÏä§ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
    this.setupSheetCheckboxListeners();
  }

  setupSheetCheckboxListeners() {
    const checkboxes = document.querySelectorAll(".sheet-checkbox");
    checkboxes.forEach((checkbox) => {
      checkbox.addEventListener("change", this.updateSelectedSheets.bind(this));
    });
  }

  updateSelectedSheets() {
    const checkboxes = document.querySelectorAll(".sheet-checkbox:checked");
    this.selectedSheets = Array.from(checkboxes).map((cb) => ({
      fileName: cb.dataset.file,
      sheetName: cb.dataset.sheet,
    }));

    const previewBtn = document.getElementById("previewSelectedBtn");
    if (previewBtn) {
      previewBtn.disabled = this.selectedSheets.length === 0;
    }
  }

  selectAllSheets() {
    const checkboxes = document.querySelectorAll(".sheet-checkbox");
    checkboxes.forEach((cb) => (cb.checked = true));
    this.updateSelectedSheets();
  }

  deselectAllSheets() {
    const checkboxes = document.querySelectorAll(".sheet-checkbox");
    checkboxes.forEach((cb) => (cb.checked = false));
    this.updateSelectedSheets();
  }

  // ÏãúÌä∏ ÎØ∏Î¶¨Î≥¥Í∏∞
  previewSheet(fileName, sheetName) {
    // Í∞ÑÎã®Ìïú Î™®Îã¨Ïù¥ÎÇò ÌåùÏóÖÏúºÎ°ú ÎØ∏Î¶¨Î≥¥Í∏∞Î•º Î≥¥Ïó¨Ï§Ñ Ïàò ÏûàÏùå
    // ÌòÑÏû¨Îäî alertÎ°ú ÎåÄÏ≤¥
    alert(
      window.t
        ? window.t("sheetSelector.alerts.previewInfo", {
            fileName: fileName,
            sheetName: sheetName,
          })
        : `${fileName}Ïùò "${sheetName}" ÏãúÌä∏ ÎØ∏Î¶¨Î≥¥Í∏∞\n(ÎØ∏Î¶¨Î≥¥Í∏∞ Í∏∞Îä•ÏùÄ 3Îã®Í≥ÑÏóêÏÑú ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§)`
    );
  }

  // 3Îã®Í≥Ñ: ÎØ∏Î¶¨Î≥¥Í∏∞
  goToPreview() {
    if (this.selectedSheets.length === 0) {
      alert(
        window.t
          ? window.t("common.messages.noSelectedSheets")
          : "ÏÑ†ÌÉùÎêú ÏãúÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§."
      );
      return;
    }

    this.goToStep(3);
    this.displayPreviewSummary();
    this.displayPreviewTabs();
    this.displayFirstPreview();
  }

  displayPreviewSummary() {
    const summaryEl = document.getElementById("previewSummary");
    if (!summaryEl) return;

    const fileCount = new Set(this.selectedSheets.map((s) => s.fileName)).size;

    summaryEl.innerHTML = `
            <h4>${
              window.t
                ? window.t("sheetSelector.info.selectedSheets")
                : "ÏÑ†ÌÉùÎêú ÏãúÌä∏ Ï†ïÎ≥¥"
            }</h4>
            <div class="summary-stats">
                <div class="stat-item">
                    <span class="stat-number">${fileCount}</span>
                    <span class="stat-label">${
                      window.t ? window.t("common.file") : "ÌååÏùº"
                    }</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${
                      this.selectedSheets.length
                    }</span>
                    <span class="stat-label">${
                      window.t ? window.t("common.sheet") : "ÏãúÌä∏"
                    }</span>
                </div>
            </div>
        `;
  }

  displayPreviewTabs() {
    const tabsEl = document.getElementById("previewTabs");
    if (!tabsEl) return;

    tabsEl.innerHTML = "";

    this.selectedSheets.forEach((sheet, index) => {
      const tab = document.createElement("button");
      tab.className = `preview-tab ${index === 0 ? "active" : ""}`;
      tab.textContent = `${sheet.sheetName} (${sheet.fileName})`;
      tab.onclick = () => this.showPreviewTab(index);
      tabsEl.appendChild(tab);
    });
  }

  showPreviewTab(index) {
    // ÌÉ≠ ÌôúÏÑ±Ìôî
    document.querySelectorAll(".preview-tab").forEach((tab, i) => {
      tab.classList.toggle("active", i === index);
    });

    // ÏãúÌä∏ ÎÇ¥Ïö© ÌëúÏãú
    const sheet = this.selectedSheets[index];
    this.displaySheetPreview(sheet.fileName, sheet.sheetName);
  }

  displayFirstPreview() {
    if (this.selectedSheets.length > 0) {
      const sheet = this.selectedSheets[0];
      this.displaySheetPreview(sheet.fileName, sheet.sheetName);
    }
  }

  displaySheetPreview(fileName, sheetName) {
    const contentEl = document.getElementById("previewContent");
    if (!contentEl) return;

    const workbook = this.fileWorkbooks.get(fileName);
    if (!workbook || !workbook.Sheets[sheetName]) {
      contentEl.innerHTML = `<div class="preview-placeholder">${
        window.t
          ? window.t("common.messages.cannotLoadSheet")
          : "ÏãúÌä∏Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§."
      }</div>`;
      return;
    }

    const sheet = workbook.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    if (jsonData.length === 0) {
      contentEl.innerHTML = `<div class="preview-placeholder">${
        window.t ? window.t("common.messages.emptySheet") : "Îπà ÏãúÌä∏ÏûÖÎãàÎã§."
      }</div>`;
      return;
    }

    // ÎØ∏Î¶¨Î≥¥Í∏∞ ÌÖåÏù¥Î∏î ÏÉùÏÑ± (ÏµúÎåÄ 20Ìñâ)
    let tableHTML = '<table class="preview-table">';

    // Ìó§Îçî
    if (jsonData.length > 0) {
      tableHTML += "<thead><tr>";
      jsonData[0].forEach((cell) => {
        tableHTML += `<th>${this.escapeHtml(cell || "")}</th>`;
      });
      tableHTML += "</tr></thead>";
    }

    // Îç∞Ïù¥ÌÑ∞ (ÏµúÎåÄ 19Ìñâ)
    tableHTML += "<tbody>";
    for (let i = 1; i < Math.min(20, jsonData.length); i++) {
      tableHTML += "<tr>";
      jsonData[i].forEach((cell) => {
        tableHTML += `<td>${this.escapeHtml(cell || "")}</td>`;
      });
      tableHTML += "</tr>";
    }
    tableHTML += "</tbody></table>";

    contentEl.innerHTML = tableHTML;
  }

  // 4Îã®Í≥Ñ: Î≥ëÌï© Ïã§Ìñâ
  async mergeSelectedSheets() {
    if (this.selectedSheets.length === 0) return;

    this.showProgress(
      window.t
        ? window.t("sheetSelector.progress.merging")
        : "ÏãúÌä∏Îì§ÏùÑ Î≥ëÌï©ÌïòÎäî Ï§ë...",
      0
    );

    try {
      this.mergedWorkbook = XLSX.utils.book_new();
      const usedNames = new Set();

      for (let i = 0; i < this.selectedSheets.length; i++) {
        const { fileName, sheetName } = this.selectedSheets[i];
        const progress = (i / this.selectedSheets.length) * 100;

        this.updateProgress(
          window.t
            ? window.t("sheetSelector.progress.processing", {
                sheetName: sheetName,
              })
            : `${sheetName} Ï≤òÎ¶¨ Ï§ë...`,
          progress
        );

        const workbook = this.fileWorkbooks.get(fileName);
        if (!workbook || !workbook.Sheets[sheetName]) continue;

        // ÏãúÌä∏ Ïù¥Î¶Ñ Ï§ëÎ≥µ Ï≤òÎ¶¨
        let finalSheetName = sheetName;
        let counter = 1;
        while (usedNames.has(finalSheetName)) {
          finalSheetName = `${sheetName}_${counter}`;
          counter++;
        }
        usedNames.add(finalSheetName);

        // ÏãúÌä∏ Î≥µÏÇ¨
        const originalSheet = workbook.Sheets[sheetName];
        const newSheet = XLSX.utils.json_to_sheet(
          XLSX.utils.sheet_to_json(originalSheet, { header: 1 }),
          { skipHeader: false }
        );

        XLSX.utils.book_append_sheet(
          this.mergedWorkbook,
          newSheet,
          finalSheetName
        );
      }

      this.hideProgress();
      this.goToStep(4);
      this.displayMergeResult();
    } catch (error) {
      this.hideProgress();
      alert(
        (window.t
          ? window.t("sheetSelector.errors.mergeError")
          : "ÏãúÌä∏ Î≥ëÌï© Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:") +
          " " +
          error.message
      );
      console.error(error);
    }
  }

  displayMergeResult() {
    const resultEl = document.getElementById("mergeResult");
    if (!resultEl) return;

    const sheetCount = this.mergedWorkbook
      ? this.mergedWorkbook.SheetNames.length
      : 0;

    resultEl.innerHTML = `
            <div class="merge-success-icon">‚úÖ</div>
            <h3 class="merge-success-title">${
              window.t
                ? window.t("sheetSelector.info.mergeComplete")
                : "Î≥ëÌï© ÏôÑÎ£å!"
            }</h3>
            <div class="merge-details">
                ${
                  window.t
                    ? window.t("sheetSelector.info.mergeSuccess", {
                        sheetCount: sheetCount,
                      })
                    : `Ï¥ù ${sheetCount}Í∞úÏùò ÏãúÌä∏Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥ëÌï©ÎêòÏóàÏäµÎãàÎã§.<br>Ïù¥Ï†ú ÌååÏùºÏùÑ Îã§Ïö¥Î°úÎìúÌï† Ïàò ÏûàÏäµÎãàÎã§.`
                }
            </div>
        `;
  }

  downloadMergedFile() {
    if (!this.mergedWorkbook) {
      alert(
        window.t
          ? window.t("common.messages.noMergedFile")
          : "Î≥ëÌï©Îêú ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§."
      );
      return;
    }

    try {
      const date = new Date();
      const filename = `${
        window.t ? window.t("sheetSelector.fileNames.prefix") : "ÏãúÌä∏Î≥ëÌï©_"
      }${ExcelWizardApp.formatDate(date)}.xlsx`;
      XLSX.writeFile(this.mergedWorkbook, filename);
    } catch (error) {
      alert(
        (window.t
          ? window.t("sheetSelector.errors.downloadError")
          : "Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:") +
          " " +
          error.message
      );
      console.error(error);
    }
  }

  // Îã®Í≥Ñ Ï†ÑÌôò
  goToStep(stepNumber) {
    this.currentStep = stepNumber;

    // Î™®Îì† Îã®Í≥Ñ Ïà®Í∏∞Í∏∞
    document.querySelectorAll(".step-section").forEach((section) => {
      section.classList.remove("active");
    });

    // ÏÑ†ÌÉùÌïú Îã®Í≥Ñ Î≥¥Ïù¥Í∏∞
    const stepIds = {
      1: "fileUploadStep",
      2: "sheetSelectionStep",
      3: "previewStep",
      4: "resultStep",
    };

    const targetStep = document.getElementById(stepIds[stepNumber]);
    if (targetStep) {
      targetStep.classList.add("active");
    }
  }

  // ÏßÑÌñâÎ•† ÌëúÏãú
  showProgress(text, percent = 0) {
    let overlay = document.getElementById("progressOverlay");
    if (!overlay) {
      overlay = document.createElement("div");
      overlay.id = "progressOverlay";
      overlay.className = "progress-overlay";
      overlay.innerHTML = `
                <div class="progress-modal">
                    <div class="progress-spinner">‚è≥</div>
                    <div class="progress-text" id="progressText">${text}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: ${percent}%"></div>
                    </div>
                </div>
            `;
      document.body.appendChild(overlay);
    }

    document.getElementById("progressText").textContent = text;
    document.getElementById("progressFill").style.width = percent + "%";
    overlay.classList.add("active");
  }

  updateProgress(text, percent) {
    const textEl = document.getElementById("progressText");
    const fillEl = document.getElementById("progressFill");

    if (textEl) textEl.textContent = text;
    if (fillEl) fillEl.style.width = percent + "%";
  }

  hideProgress() {
    const overlay = document.getElementById("progressOverlay");
    if (overlay) {
      overlay.classList.remove("active");
    }
  }

  // ÎèÑÍµ¨ Ï¥àÍ∏∞Ìôî
  resetTool() {
    this.uploadedFiles = [];
    this.fileWorkbooks.clear();
    this.selectedSheets = [];
    this.mergedWorkbook = null;
    this.currentStep = 1;
    this.currentPreviewSheet = null;

    this.goToStep(1);
    this.updateUploadedFilesList();
    this.updateAnalyzeButton();

    const fileInput = document.getElementById("sheetSelectorFileInput");
    if (fileInput) fileInput.value = "";
  }

  // Ïú†Ìã∏Î¶¨Ìã∞ Î©îÏÑúÎìú
  readFileAsArrayBuffer(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  formatFileSize(bytes) {
    if (bytes === 0) return "0 Bytes";
    const k = 1024;
    const sizes = ["Bytes", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
  }

  escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = (hash << 5) - hash + char;
      hash = hash & hash; // 32bit intÎ°ú Î≥ÄÌôò
    }
    return Math.abs(hash);
  }
}

// Ï†ÑÏó≠ Ïù∏Ïä§ÌÑ¥Ïä§ (HTML onclick Ïù¥Î≤§Ìä∏Ïö©)
let sheetSelectorTool;
